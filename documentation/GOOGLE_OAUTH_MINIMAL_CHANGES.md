# Google OAuth Minimal Registration - Implementation Summary

## Overview
Streamlined Google OAuth registration to use only **3 core values**: `email`, `username`, and `idToken`. Removed dependency on `profileImage` and other optional fields.

## Changes Made

### 1. Backend Changes (tastyplates-user-rest-api-plugin.php)

#### A. Simplified GraphQL Input Schema (Lines 183-196)
**Before:**
```php
'inputFields' => [
    'idToken' => [...],
    'email' => [...],
    'username' => [...],
    'profileImage' => [...],  // ❌ Removed
    'name' => [...],          // ❌ Removed
],
```

**After:**
```php
'inputFields' => [
    'idToken' => [
        'type' => 'String',
        'description' => 'Google ID token (required for verification)',
    ],
    'email' => [
        'type' => 'String',
        'description' => 'User email (optional, extracted from token if not provided)',
    ],
    'username' => [
        'type' => 'String',
        'description' => 'Username (optional, auto-generated from email if not provided)',
    ],
],
```

#### B. Simplified REST API Call Body (Lines 305-311)
**Before:**
```php
'body' => json_encode([
    'email' => $email,
    'username' => $username,
    'password' => '',
    'is_google_user' => true,
    'profile_image' => !empty($input['profileImage']) ? $input['profileImage'] : '',  // ❌ Removed
]),
```

**After:**
```php
'body' => json_encode([
    'email' => $email,
    'username' => $username,
    'is_google_user' => true,
    // Password auto-generated by backend when is_google_user=true
    // profile_image omitted - optional field
]),
```

### 2. Frontend Changes

#### A. TypeScript Types (src/app/graphql/User/userMutations.types.ts)
**Before:**
```typescript
export interface RegisterGoogleUserInput {
  email: string;
  idToken: string;
  username?: string;
  profileImage?: string;  // ❌ Removed
  name?: string;          // ❌ Removed
}
```

**After:**
```typescript
export interface RegisterGoogleUserInput {
  idToken: string; // Google ID token (required for verification)
  email?: string; // Optional - extracted from token if not provided
  username?: string; // Optional - auto-generated from email if not provided
}
```

#### B. Updated Documentation (src/app/graphql/User/README.md)
Added examples showing:
- Minimal usage with only `idToken`
- Optional custom username override
- Clarified that email is extracted from token automatically

### 3. What Doesn't Need to Change

✅ **No changes needed** for:

1. **REST API `create_item` method** - Already handles OAuth users correctly
2. **`prepare_item_for_database`** - Already auto-generates passwords for OAuth
3. **`wp_insert_user`** - Already treats ACF fields as optional
4. **ACF field handling** - Already gracefully handles missing fields
5. **Frontend Register component** - Uses REST API which works with these changes

## How It Works Now

### Backend Flow:
1. Frontend sends `idToken` (+ optional `email`/`username`)
2. Backend verifies `idToken` with Google
3. Backend extracts `email` from token (if not provided)
4. Backend auto-generates `username` from email (if not provided)
5. Backend auto-generates secure random `password`
6. Backend sets `is_google_user` = `'1'` in user meta
7. Backend creates user with only core fields
8. Backend returns JWT token

### Frontend Usage:

**Minimal (GraphQL):**
```typescript
import { REGISTER_USER_WITH_GOOGLE } from '@/app/graphql/User';

const result = await client.mutate({
  mutation: REGISTER_USER_WITH_GOOGLE,
  variables: {
    input: {
      idToken: googleCredential.credential,
      // That's it! Email and username auto-generated
    }
  }
});
```

**With Custom Username (GraphQL):**
```typescript
const result = await client.mutate({
  mutation: REGISTER_USER_WITH_GOOGLE,
  variables: {
    input: {
      idToken: googleCredential.credential,
      username: 'mycustomusername',
    }
  }
});
```

**Current REST API Usage (Register.tsx):**
The existing `handleGoogleRestRegistration` function already works with these changes since it calls the same backend endpoint that the GraphQL mutation uses internally.

## Benefits

1. ✅ **Simpler API** - Only 1 required field (`idToken`)
2. ✅ **No ACF dependency** - Works without ACF fields being defined
3. ✅ **No profile image needed** - Can be added later via profile update
4. ✅ **Backward compatible** - Existing code continues to work
5. ✅ **Auto-generation** - Email and username extracted/generated automatically
6. ✅ **Secure** - Password auto-generated with WordPress's secure function

## Testing

Test the minimal flow with:

```typescript
// Test 1: Absolute minimum (only idToken)
await client.mutate({
  mutation: REGISTER_USER_WITH_GOOGLE,
  variables: {
    input: {
      idToken: googleCredential.credential,
    },
  },
});

// Test 2: With custom username
await client.mutate({
  mutation: REGISTER_USER_WITH_GOOGLE,
  variables: {
    input: {
      idToken: googleCredential.credential,
      username: 'mycustomusername',
    },
  },
});
```

## Files Modified

### Backend:
- `documentation/tastyplates-user-rest-api-plugin.php`
  - Lines 183-196: Simplified GraphQL input schema
  - Lines 305-311: Removed profile_image from REST call

### Frontend:
- `src/app/graphql/User/userMutations.types.ts`
  - Lines 166-170: Simplified RegisterGoogleUserInput interface
- `src/app/graphql/User/README.md`
  - Lines 127-163: Updated documentation with minimal examples

### Documentation:
- `documentation/GOOGLE_OAUTH_MINIMAL_CHANGES.md` (this file)

## Migration Notes

**For existing code:**
- No breaking changes - optional fields remain optional
- Existing calls with `profileImage` will still work (field is ignored)
- Frontend can continue using current REST API approach

**For new code:**
- Use minimal approach with only `idToken`
- Add profile image later via profile update mutation if needed
- Username can be customized during registration or changed later

## Summary

The Google OAuth registration flow has been successfully streamlined to require only the essential `idToken` field. The backend automatically:
- Verifies the token with Google
- Extracts email from the token
- Generates a unique username
- Creates a secure password
- Marks the user as a Google OAuth user

This provides a cleaner, more maintainable API while preserving all functionality.

